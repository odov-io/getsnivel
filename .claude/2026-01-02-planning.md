# Planning Notes - January 2, 2026

---

## 0. Pricing Model & Solo vs Org (DECIDED)

### The Model

**Solo License**
- Still creates an org under the hood (data model stays clean)
- Simplified UX - org settings hidden/auto-defaulted
- 1 seat, 1 person, full features
- When they add user #2 → triggers "upgrade to team"

**Team/Org License**
- Sold in packs of 5 (5, 10, 25, 50?)
- Full org settings exposed (push settings, user management)
- Per-seat gets cheaper as pack size grows
- Natural growth path from solo

### Trial & Billing

- **30 day trial** - full features
- **No card upfront**
- No free tier ever

### Account Lifecycles

**TRIAL LIFECYCLE**
```
Day 0-30:   Active (full access)
Day 31-45:  Frozen (data intact, can't use, reminder emails)
Day 45-90:  Soft Delete (recoverable via domain auth + CC)
Day 91+:    Hard Delete (gone forever)
```

**PAID LIFECYCLE (payment failure)**
```
Day 1:      Reminder email
Day 7:      Reminder + warning
Day 14:     Final reminder
Day 15:     Freeze → Soft Delete (with notice)
Day 15-90:  Soft Delete (recoverable via domain auth + CC)
Day 91+:    Hard Delete (gone forever)
```

**States:**
- Active = full access
- Frozen = can log in, can't book, banner showing status
- Soft Delete = org hidden, data preserved, recoverable
- Hard Delete = data purged, gone forever

**NOTE:** These timelines need to be in Terms of Service / legal docs.

### Domain Intelligence

```
New signup: jane@acme.com

IF acme.com has ACTIVE org:
  → "Acme Corp is on Snivel. Request to join?"
  → Admin approves, they're added

IF acme.com has SOFT-DELETED org:
  → "Acme Corp was on Snivel but is inactive"
  → Option 1: "Request to Join" (notify old admin, maybe they reactivate)
  → Option 2: "Claim & Reactivate" (REQUIRES CC + domain validation)

IF acme.com has no org (or hard-deleted):
  → Normal fresh signup
  → Later: "2 others from acme.com signed up separately. Consolidate?"
```

### Soft-Delete Recovery / Takeover (CC = Proof of Authority)

Credit card entry proves authority to make purchasing decisions.
Random staff won't have company card. This is a natural filter.

```
Recovery/Takeover Flow:
1. New person sees soft-deleted org for their domain
2. Options: "Request to Join" or "Claim & Reactivate"
3. "Claim & Reactivate" requires:
   - Domain email validation (prove you're @acme.com)
   - Credit card entry (prove you have authority)
4. CC entered → they become new admin, org reactivated
5. Old admin notified: "Jane reactivated and claimed admin for Acme Corp"
6. Old admin can dispute via support if wrong
```

### Cron Job Additions Needed

Add to the 15-minute cron:

**Trial lifecycle:**
- Day 25, 28, 30: Trial expiration warnings
- Day 31: Freeze account
- Day 31-45: "Frozen" reminder emails
- Day 45: Soft delete
- Day 91: Hard delete

**Paid lifecycle (payment failure):**
- Day 1, 7, 14: Payment failure reminders
- Day 15: Freeze + soft delete
- Day 91: Hard delete

**Domain intelligence:**
- Check for duplicate domain signups → notify about consolidation
- Notify existing orgs when same-domain users sign up separately

### Code Impact

Minimal architecture change:
- Solo = org with `plan: "solo"` and `maxSeats: 1`
- UI conditionally hides org settings when `plan === "solo"`
- Upgrade flow = change plan type + reveal settings
- No separate data model for individuals

### Pricing (DECIDED)

**17% annual discount across all tiers. $2/user/mo floor.**

| Tier | Monthly | Per-User/Mo | Annual | Annual/User/Mo |
|------|---------|-------------|--------|----------------|
| Solo (1) | $4 | $4.00 | $40 | $3.33 |
| Team 5 | $20 | $4.00 | $200 | $3.33 |
| Team 10 | $35 | $3.50 | $350 | $2.92 |
| Team 25 | $75 | $3.00 | $750 | $2.50 |
| Team 50 | $140 | $2.80 | $1,400 | $2.33 |
| Team 75 | $190 | $2.53 | $1,900 | $2.11 |
| Team 100 | $240 | $2.40 | $2,400 | $2.00 |
| **100+** | $2.40/user | $2.40 | $24/user | $2.00 |

**Key points:**
- All features included at every tier (no feature gating)
- Monthly per-user progression: $4.00 → $4.00 → $3.50 → $3.00 → $2.80 → $2.53 → $2.40
- Annual per-user progression: $3.33 → $3.33 → $2.92 → $2.50 → $2.33 → $2.11 → $2.00
- 100+ customers pay per-seat at the floor rate
- No inversions - larger teams always pay same or less per user

---

## 1. Pricing & Payment Collection

### Payment Provider (DECIDED)

**Stripe + Stripe Tax**
- Stripe handles subscriptions, billing, customer portal
- Stripe Tax auto-calculates and collects sales tax by jurisdiction
- Export reports → hand to accountant for filing/remittance
- Native Deno SDK support

### Stripe Integration
- Set up Stripe account/keys (test + live)
- Enable Stripe Tax in dashboard
- Install Stripe SDK for Deno
- Create products and price IDs in Stripe dashboard

### Subscription Flow
- Checkout session creation (redirect to Stripe)
- Success/cancel return URLs
- Webhook endpoint to handle:
  - `checkout.session.completed` - activate subscription
  - `customer.subscription.updated` - plan changes
  - `customer.subscription.deleted` - cancellation
  - `invoice.payment_failed` - handle failed payments

### Data Model
- Store `stripeCustomerId` on org
- Store `subscriptionId`, `planId`, `status`, `currentPeriodEnd`
- Track subscription state: `trialing`, `active`, `past_due`, `canceled`

### Plan Tiers (to decide)
- **Free tier** - what's included? (1 user? limited bookings/month?)
- **Pro tier** - full features, multiple users
- **Enterprise** - custom pricing, SSO, etc.?

### Billing Portal
- Let customers manage their subscription (upgrade/downgrade/cancel)
- Stripe Customer Portal or custom UI?

### Feature Gating
- Check subscription status before allowing:
  - Additional users
  - Premium features (calendar sync, custom branding, etc.)
  - API access?

---

## 2. APIs & Access

### Two API Audiences

#### Org-Level API (for integrations, admin tools)
- Manage users in org
- Bulk update settings
- List/manage all bookings
- Analytics/reporting data
- Webhook configuration

#### End-User/Public API (for embedding, third-party apps)
- Get user availability
- Create bookings
- Cancel/reschedule bookings
- Get booking details (by token)

### Authentication Options

#### API Keys
- Generate per-org API keys
- Store hashed in DB
- Include in header: `Authorization: Bearer sk_live_xxx`
- Scopes? (read-only, full access, booking-only)

#### OAuth (future?)
- For third-party apps acting on behalf of users
- More complex, maybe v2

### API Key Management
- Generate/revoke keys in dashboard
- Last used timestamp
- Optional expiration
- Multiple keys per org (for different integrations)

### Rate Limiting
- Per-key limits (e.g., 1000 req/hour)
- Different limits for free vs paid plans
- Return `429 Too Many Requests` with `Retry-After` header
- Use Deno KV for tracking (or Redis if needed at scale)

### API Routes Structure
```
/api/v1/org/users
/api/v1/org/users/[id]
/api/v1/org/bookings
/api/v1/org/settings

/api/v1/availability/[userSlug]
/api/v1/bookings
/api/v1/bookings/[token]
```

### Documentation
- OpenAPI/Swagger spec
- Host docs at docs.snivel.app or /api/docs
- Code examples (curl, JS, Python)

### Webhooks (outbound)
- Let orgs register webhook URLs
- Events: `booking.created`, `booking.canceled`, `booking.rescheduled`
- Signature verification (HMAC)
- Retry logic for failed deliveries

---

## Questions to Decide

1. ~~**Free tier limits**~~ - DECIDED: No free tier ever
2. ~~**Trial period**~~ - DECIDED: 30 days, no card upfront
3. **API access** - All tiers or paid only?
4. ~~**Pricing**~~ - DECIDED: See pricing table above
5. **Grandfathering** - Lock in early adopters at lower price?

---

## Files Likely to Touch

### Payments
- `lib/stripe/client.ts` - Stripe SDK setup
- `lib/stripe/webhooks.ts` - Webhook handlers
- `lib/db/subscriptions.ts` - Subscription data layer
- `routes/api/stripe/checkout.ts` - Create checkout session
- `routes/api/stripe/webhook.ts` - Handle Stripe events
- `routes/api/stripe/portal.ts` - Billing portal redirect
- `islands/Dashboard.tsx` - Show subscription status, upgrade prompts

### APIs
- `lib/api/keys.ts` - API key generation/validation
- `lib/api/ratelimit.ts` - Rate limiting logic
- `middleware/api-auth.ts` - API key authentication
- `routes/api/v1/...` - Versioned API routes
- `routes/dashboard/api-keys.tsx` - Key management UI
